---
title: "Project memo"
author: "Group 7"
output: github_document
---

This document should contain a detailed account of the data clean up for your data and the design choices you are making for your plots. For instance you will want to document choices you've made that were intentional for your graphic, e.g. color you've chosen for the plot. Think of this document as a code script someone can follow to reproduce the data cleaning steps and graphics in your handout.

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
library(readxl)
library(usmap)
library(ggrepel)
```

## Data Clean Up Steps for Overall Data


### Step 1: Data Cleaning
We loaded, cleaned, and merged the energy and population datasets by state and included only the data from 2019. We then calculated per-capita values for all energy-related variables and added those new columns back into the main dataset. 

```{r general_data_cleaning}
setwd("/cloud/project")

energy <- read_csv("data/energy.csv")
filtered_energy <- energy %>%
  filter(Year == 2019) %>%
  select(State, Year, starts_with(c("Consumption", "Expenditure", "Price")))

population <- read_excel("data/Population.xlsx")
filtered_population <- population[c(-(1:8),-(60:66)),] %>%
  rename(Population = "...13",
         State = "table with row headers in column A and column headers in rows 3 through 4. (leading dots indicate sub-parts)") %>%
  mutate(State = substr(State, 2, nchar(State))) %>%
  select(State, Population)

joined <- filtered_energy %>%
  left_join(filtered_population, by = c("State" = "State"))

variables <- colnames(joined)
variables <- variables[-c(1:2,84)]

per_cap <- joined %>%
  mutate(across(variables, ~ .x / joined$Population))

for (var in variables) {
  per_cap[[paste0(var, "_pc")]] <- per_cap[[var]]
}

per_cap <- per_cap %>%
  select(State, Year, ends_with("pc"))

final <- joined %>%
  left_join(per_cap, by = c("State" = "State"))

# Print the output of glimpse() or skim()
glimpse(final)
```


### Step 2: Visualizations

### Plot 1: Commercial Petroleum Consumption Map

For this first plot, we started by adding a lowercase state column to ensure that the data aligns with the mapping package’s format. This plot then showcases a U.S. map shaded by each state’s commercial petroleum consumption, using a gradient to highlight differences in energy use. The plot is able to show when commercial petroleum is consumed the most. 

#### Data cleanup specific to plot 1

```{r adjust_state_label}
final <- final %>%
  mutate(state = State)
```

#### Final Plot 1

```{r creat_map_petroleum, warning=FALSE, fig.alt = "Map of the United States with blue gradient fill representing the Commercial Petroleum Consumption of each state. California and New York stand out as the largest consumers."}
plot_usmap(
  linewidth = 0.1,
  color = "white",
  regions = "state",
  data = final,
  values = 'Consumption.Commercial.Petroleum'
) +
  scale_fill_gradient(
    labels = scales::label_number(big.mark = ','),
    high = 'steelblue',
    low = 'white'
  ) +
  labs(fill = 'Consumption (Billions BTU)',
       title = "Commercial Petroleum Consumption by State Across U.S.A.") +
  guides(
    fill = guide_colorbar(barwidth = unit(8, 'cm'))
  ) +
  theme(
    legend.position = 'top',
    plot.title = element_text(hjust = 0.5)  # <-- Center the title
  )
```


### Plot 2: Commercial Petroleum Consumption Per Capita Map 

```{r creat_map_petroleum_pc, warning=FALSE, fig.alt = "Map of the United States with blue gradient fill representing the commercial petroleum consumption per capita of each state. Alaska, Maine, Vermont, and New Hampshire stand out as the largest consumers per capita."}
plot_usmap(
  linewidth = 0.1,
  color = "white",
  regions = "state",
  data = final,
  values = 'Expenditure.Commercial.Petroleum_pc'
) +
  scale_fill_gradient(
    labels = scales::label_number(big.mark = ','),
    high = 'steelblue',
    low = 'white'
  ) +
  labs(fill = 'Consumption (Billions BTU)',
       title = "Commercial Petroleum Consumption by State Across U.S.A.") +
  guides(
    fill = guide_colorbar(barwidth = unit(8, 'cm'))
  ) +
  theme(
    legend.position = 'top',
    plot.title = element_text(hjust = 0.5)  # <-- Center the title
  )
```

### Plot 3: Petroleum Expenditure Per Capita vs Petroleum Dependance

#### Data cleanup specific to plot 3

#Note: rowSums, grepl, contains, and ends_with are functions for creating aggreates of multiple variables based on naming conventions learned from ECON 368 with Professor Kyle Coombs.

```{r create_expenditure_plot_data}

expenditure_plot_data <- final %>%
  mutate(
    total_consumption_pc = rowSums(select(., ends_with("_pc")), na.rm = TRUE),
    
    petroleum_consumption_pc = rowSums(
      select(., contains("Consumption") & contains("Petroleum") & ends_with("_pc")), na.rm = TRUE),
    
    petroleum_dependence = petroleum_consumption_pc / total_consumption_pc,
    
    petroleum_expenditure_pc = rowSums(
      select(., contains("Expenditure") & contains("Petroleum") & ends_with("_pc")), na.rm = TRUE)
  )

```

#### Final Plot 3:

```{r expenditure_plot, fig.alt = "Scatter plot with trend line displaying correlation between petroleum expenditure per capita and petroleum dependance. The slope of the trend line is slightly negative."}

expenditure_plot <- ggplot(expenditure_plot_data, aes(x = petroleum_dependence,
                        y = petroleum_expenditure_pc,
                        label = State)) +
  geom_point(size = 3, alpha = 0.8, color = "steelblue") +   # steel blue
  geom_smooth(method = "lm", color = "blue", linewidth = 1, se = TRUE) +
  geom_text_repel(size = 3, color = "black") +
  labs(
    title = "Petroleum Expenditure per Capita vs. Petroleum Dependence",
    x = "Proportion of Total State Consumption of Petroleum",
    y = "Petroleum Expenditure per Capita (USD)"
  ) +
  theme_minimal(base_size = 11.5)

expenditure_plot

```


### Plot 4: Petroleum Price vs. Petroleum Dependance

#### Data cleanup specific to plot 3

```{r create_price_plot_data}

price_plot_data <- final %>%
  mutate(
    total_consumption_pc = rowSums(select(., ends_with("_pc")), na.rm = TRUE),
    
    petroleum_consumption_pc = rowSums(
      select(., contains("Consumption") & contains("Petroleum") & ends_with("_pc")), na.rm = TRUE),
    
    petroleum_dependence = petroleum_consumption_pc / total_consumption_pc,
    
    petroleum_price = rowMeans(
      select(., contains("Price") & contains("Petroleum")), na.rm = TRUE)
  )

```

#### Final Plot 4:

```{r price_plot, fig.alt = "Scatter plot with trend line displaying correlation between petroleum price and petroleum dependance. The slope of the trend line is approximately 0 and is horizontal across the plot."}

price_plot <- ggplot(price_plot_data, aes(x = petroleum_dependence,
                        y = petroleum_price,
                        label = State)) +
  geom_point(size = 3, alpha = 0.8, color = "steelblue") +
  geom_smooth(method = "lm", color = "blue", linewidth = 1, se = TRUE) +
  geom_text_repel(size = 3, color = "black") +
  labs(
    x = "Proportion of Total State Consumption from Petroleum",
    y = "Average Petroleum Price (USD per million BTU)"
  ) +
  theme_minimal(base_size = 11.5) +
  theme(
    axis.text = element_text(size = 10.5),
    axis.title = element_text(size = 10.5)
  )

price_plot

```


